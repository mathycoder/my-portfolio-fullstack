{"ast":null,"code":"'use strict'; // This file is largely based upon the work done for node-pre-gyp. We are not\n// using that module directly due to issues we've run into with the intricacies\n// of various node and npm versions that we must support.\n// https://www.npmjs.com/package/node-pre-gyp\n// XXX This file must not have any deps. This file will run during the install\n// XXX step of the module and we are _not_ guaranteed that the dependencies have\n// XXX already installed. Core modules are okay.\n\nvar cp = require('child_process');\n\nvar fs = require('fs');\n\nvar http = require('http');\n\nvar https = require('https');\n\nvar os = require('os');\n\nvar path = require('path');\n\nvar semver = require('semver');\n\nvar zlib = require('zlib');\n\nvar CPU_COUNT = os.cpus().length;\nvar IS_WIN = process.platform === 'win32';\nvar HAS_OLD_NODE_GYP_ARGS_FOR_WINDOWS = semver.lt(gypVersion() || '0.0.0', '3.7.0');\nvar S3_BUCKET = 'nr-downloads-main';\nvar DOWNLOAD_HOST = process.env.NR_NATIVE_METRICS_DOWNLOAD_HOST || 'https://download.newrelic.com/';\nvar REMOTE_PATH = process.env.NR_NATIVE_METRICS_REMOTE_PATH || 'nodejs_agent/builds/';\nvar PACKAGE_ROOT = path.resolve(__dirname, '..');\nvar BUILD_PATH = path.resolve(PACKAGE_ROOT, './build/Release');\nvar opts = {};\nexports.load = load;\n\nif (require.main === module) {\n  var argv = parseArgs(process.argv, opts);\n  executeCli(argv[2], argv[3]);\n}\n\nfunction _getFileName(target) {\n  var abi = process.versions.modules;\n  var arch = process.arch;\n  var platform = process.platform;\n\n  var pkg = require('../package');\n\n  var pkgName = pkg.name.replace(/[^\\w]/g, '_');\n  var pkgVersion = pkg.version.toString().replace(/[^\\w]/g, '_');\n\n  if (!abi || !arch || !target || !platform || !pkg || !pkgName || !pkgVersion) {\n    throw new Error('Missing information for naming compiled binary.');\n  }\n\n  return [pkgName, pkgVersion, target, abi, platform, arch].join('-');\n}\n\nfunction getBinFileName(target) {\n  return _getFileName(target) + '.node';\n}\n\nfunction getPackageFileName(target) {\n  return _getFileName(target) + '.gz';\n}\n\nfunction load(target) {\n  return require(path.join(BUILD_PATH, getBinFileName(target)));\n}\n\nfunction makePath(pathToMake, cb) {\n  var accessRights = null;\n\n  if (fs.constants) {\n    accessRights = fs.constants.R_OK | fs.constants.W_OK;\n  } else {\n    // TODO: Remove this when deprecating Node v5 and below.\n    accessRights = fs.R_OK | fs.W_OK;\n  } // We only want to make the parts after the package directory.\n\n\n  pathToMake = path.relative(PACKAGE_ROOT, pathToMake); // Now that we have a relative path, split it into the parts we need to make.\n\n  var pathParts = pathToMake.split(path.sep);\n\n  _make(-1, PACKAGE_ROOT, cb);\n\n  function _make(i, p, cb) {\n    if (++i >= pathParts.length) {\n      return cb();\n    }\n\n    p = path.join(p, pathParts[i]);\n    fs.access(p, accessRights, function fsAccessCB(err) {\n      if (!err) {\n        // It exists and we have read+write access! Move on to the next part.\n        return _make(i, p, cb);\n      } else if (err.code !== 'ENOENT') {\n        // It exists but we don't have read+write access! This is a problem.\n        return cb(new Error('Do not have access to \"' + p + '\": ' + err));\n      } // It probably does not exist, so try to make it.\n\n\n      fs.mkdir(p, function fsMkDirCB(err) {\n        if (err) {\n          return cb(err);\n        }\n\n        _make(i, p, cb);\n      });\n    });\n  }\n}\n\nfunction findNodeGyp() {\n  // This code heavily borrows from node-pre-gyp.\n  // https://github.com/mapbox/node-pre-gyp/blob/e0b3b6/lib/util/compile.js#L18-L55\n  // First, look for it in the NPM environment variable.\n  var gypPath = null;\n\n  if (process.env.npm_config_node_gyp) {\n    try {\n      gypPath = process.env.npm_config_node_gyp;\n\n      if (fs.existsSync(gypPath)) {\n        return gypPath;\n      }\n    } catch (err) {// This method failed, hopefully the next will succeed...\n    }\n  } // Next, see if the package is installed somewhere.\n\n\n  try {\n    var gypPkgPath = require.resolve('node-gyp');\n\n    gypPath = path.resolve(gypPkgPath, '../../bin/node-gyp.js');\n\n    if (fs.existsSync(gypPath)) {\n      return gypPath;\n    }\n  } catch (err) {} // This method failed, hopefully the next will succeed...\n  // Then look for it in NPM's install location.\n\n\n  try {\n    var npmPkgPath = require.resolve('npm');\n\n    gypPath = path.resolve(npmPkgPath, '../../node_modules/node-gyp/bin/node-gyp.js');\n\n    if (fs.existsSync(gypPath)) {\n      return gypPath;\n    }\n  } catch (err) {} // This method failed, hopefully the next will succeed...\n  // All of that failed, now look for it next to node itself.\n\n\n  var nodeNpmPkgPath = path.resolve(process.execPath, '../../lib/node_modules/npm/');\n  gypPath = path.join(nodeNpmPkgPath, 'node_modules/node-gyp/bin/node-gyp.js');\n\n  if (fs.existsSync(gypPath)) {\n    return gypPath;\n  }\n\n  return null;\n}\n\nfunction gypVersion() {\n  var cmd = null;\n  var args = ['-v'];\n  var gyp = findNodeGyp();\n\n  if (gyp) {\n    args.unshift(gyp); // push_front\n\n    cmd = process.execPath;\n  } else {\n    cmd = IS_WIN ? 'node-gyp.cmd' : 'node-gyp';\n  }\n\n  var child = cp.spawnSync(cmd, args);\n  var match = /v(\\d+\\.\\d+\\.\\d+)/.exec(child.stdout);\n  return match && match[1];\n}\n\nfunction execGyp(args, cb) {\n  var cmd = null;\n  var gyp = findNodeGyp();\n\n  if (gyp) {\n    args.unshift(gyp); // push_front\n\n    cmd = process.execPath;\n  } else {\n    cmd = IS_WIN ? 'node-gyp.cmd' : 'node-gyp';\n  }\n\n  var spawnOpts = {};\n\n  if (!opts.quiet) {\n    spawnOpts.stdio = [0, 1, 2];\n  }\n\n  console.log('> ' + cmd + ' ' + args.join(' ')); // eslint-disable-line no-console\n\n  var child = cp.spawn(cmd, args, spawnOpts);\n  child.on('error', cb);\n  child.on('close', function onGypClose(code) {\n    if (code !== 0) {\n      cb(new Error('Command exited with non-zero code: ' + code));\n    } else {\n      cb(null);\n    }\n  });\n}\n\nfunction build(target, rebuild, cb) {\n  if (IS_WIN && HAS_OLD_NODE_GYP_ARGS_FOR_WINDOWS) {\n    target = '/t:' + target;\n  }\n\n  var cmds = rebuild ? ['clean', 'configure'] : ['configure'];\n  execGyp(cmds, function cleanCb(err) {\n    if (err) {\n      return cb(err);\n    }\n\n    var jobs = Math.round(CPU_COUNT / 2);\n    execGyp(['build', '-j', jobs, target], cb);\n  });\n}\n\nfunction moveBuild(target, cb) {\n  var filePath = path.join(BUILD_PATH, target + '.node');\n  var destination = path.join(BUILD_PATH, getBinFileName(target));\n  fs.rename(filePath, destination, cb);\n}\n\nfunction download(target, cb) {\n  var hasCalledBack = false;\n  var fileName = getPackageFileName(target);\n  var url = DOWNLOAD_HOST + REMOTE_PATH + fileName;\n\n  if (DOWNLOAD_HOST.startsWith('https:')) {\n    var client = https;\n  } else {\n    console.log('Falling back to http, please consider enabling SSL on ' + DOWNLOAD_HOST);\n    var client = http;\n  }\n\n  client.get(url, function getFile(res) {\n    if (res.statusCode === 404) {\n      return cb(new Error('No pre-built artifacts for your OS/architecture.'));\n    } else if (res.statusCode !== 200) {\n      return cb(new Error('Failed to download ' + url + ': code ' + res.statusCode));\n    }\n\n    var unzip = zlib.createGunzip();\n    var buffers = [];\n    var size = 0;\n    res.pipe(unzip).on('data', function onResData(data) {\n      buffers.push(data);\n      size += data.length;\n    });\n    res.on('error', function onResError(err) {\n      if (!hasCalledBack) {\n        hasCalledBack = true;\n        cb(new Error('Failed to download ' + url + ': ' + err.message));\n      }\n    });\n    unzip.on('error', function onResError(err) {\n      if (!hasCalledBack) {\n        hasCalledBack = true;\n        cb(new Error('Failed to unzip ' + url + ': ' + err.message));\n      }\n    });\n    unzip.on('end', function onResEnd() {\n      if (hasCalledBack) {\n        return;\n      }\n\n      hasCalledBack = true;\n      cb(null, Buffer.concat(buffers, size));\n    });\n    res.resume();\n  });\n}\n\nfunction saveDownload(target, data, cb) {\n  makePath(BUILD_PATH, function makePathCB(err) {\n    if (err) {\n      return cb(err);\n    }\n\n    var filePath = path.join(BUILD_PATH, getBinFileName(target));\n    fs.writeFile(filePath, data, cb);\n  });\n}\n\nfunction install(target, cb) {\n  var errors = [];\n  var noBuild = opts['no-build'] || process.env.NR_NATIVE_METRICS_NO_BUILD;\n  var noDownload = opts['no-download'] || process.env.NR_NATIVE_METRICS_NO_DOWNLOAD; // If NR_NATIVE_METRICS_NO_BUILD env var is specified, jump straight to downloading\n\n  if (noBuild) {\n    return doDownload();\n  } // Otherwise, first attempt to build the package using the source. If that fails, try\n  // downloading the package. If that also fails, whoops!\n\n\n  build(target, true, function buildCB(err) {\n    if (!err) {\n      return moveBuild(target, function moveBuildCB(err) {\n        if (err) {\n          errors.push(err);\n          doDownload();\n        } else {\n          doCallback();\n        }\n      });\n    }\n\n    errors.push(err); // Building failed, try downloading.\n\n    doDownload();\n  });\n\n  function doDownload() {\n    if (noDownload && !noBuild) {\n      return doCallback(new Error('Downloading is disabled.'));\n    }\n\n    download(target, function downloadCB(err, data) {\n      if (err) {\n        return doCallback(err);\n      }\n\n      saveDownload(target, data, doCallback);\n    });\n  }\n\n  function doCallback(err) {\n    if (err) {\n      errors.push(err);\n      cb(err);\n    } else {\n      cb();\n    }\n  }\n}\n\nfunction upload(target, cb) {\n  // XXX This is the one external dep allowed by this module. The aws-sdk must\n  // XXX be a dev-dep of the module and uploading should only be done after\n  // XXX installing.\n  var zip = zlib.createGzip();\n  fs.createReadStream(path.join(BUILD_PATH, getBinFileName(target))).pipe(zip); // AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY must be set in the environment.\n\n  var AWS = require('aws-sdk');\n\n  var s3 = new AWS.S3();\n  s3.upload({\n    Bucket: S3_BUCKET,\n    Key: path.join(REMOTE_PATH, getPackageFileName(target)),\n    Body: zip\n  }, function s3UploadCb(err) {\n    if (err) {\n      cb(new Error('Failed to upload file: ' + err.message));\n    } else {\n      cb();\n    }\n  });\n}\n\nfunction parseArgs(_argv, _opts) {\n  var args = [];\n\n  for (var i = 0; i < _argv.length; ++i) {\n    if (/^--/.test(_argv[i])) {\n      _opts[_argv[i].substr(2)] = true;\n    } else {\n      args.push(_argv[i]);\n    }\n  }\n\n  return args;\n}\n\nfunction executeCli(cmd, target) {\n  /* eslint-disable no-console */\n  console.log(['============================================================================', `Attempting ${cmd} in native-metrics module. Please note that this is an`, 'OPTIONAL dependency, and any resultant errors in this process will not', 'affect the general performance of the New Relic agent, but event loop and', 'garbage collection metrics will not be collected.', '============================================================================', ''].join('\\n'));\n\n  if (cmd === 'build' || cmd === 'rebuild') {\n    build(target, cmd === 'rebuild', function buildCb(err) {\n      if (err) {\n        _endCli(err);\n      } else {\n        moveBuild(target, _endCli);\n      }\n    });\n  } else if (cmd === 'install') {\n    install(target, _endCli);\n  } else if (cmd === 'upload') {\n    upload(target, _endCli);\n  }\n\n  function _endCli(err) {\n    if (err) {\n      console.error(`Failed to execute native-metrics ${cmd}: ${err.message}`);\n      process.exit(1);\n    } else {\n      console.log(cmd + ' successful: ' + _getFileName(target));\n    }\n  }\n  /* eslint-enable no-console */\n\n}","map":{"version":3,"sources":["/Users/adamsarli/Coding/my-portfolio/node_modules/@newrelic/native-metrics/lib/pre-build.js"],"names":["cp","require","fs","http","https","os","path","semver","zlib","CPU_COUNT","cpus","length","IS_WIN","process","platform","HAS_OLD_NODE_GYP_ARGS_FOR_WINDOWS","lt","gypVersion","S3_BUCKET","DOWNLOAD_HOST","env","NR_NATIVE_METRICS_DOWNLOAD_HOST","REMOTE_PATH","NR_NATIVE_METRICS_REMOTE_PATH","PACKAGE_ROOT","resolve","__dirname","BUILD_PATH","opts","exports","load","main","module","argv","parseArgs","executeCli","_getFileName","target","abi","versions","modules","arch","pkg","pkgName","name","replace","pkgVersion","version","toString","Error","join","getBinFileName","getPackageFileName","makePath","pathToMake","cb","accessRights","constants","R_OK","W_OK","relative","pathParts","split","sep","_make","i","p","access","fsAccessCB","err","code","mkdir","fsMkDirCB","findNodeGyp","gypPath","npm_config_node_gyp","existsSync","gypPkgPath","npmPkgPath","nodeNpmPkgPath","execPath","cmd","args","gyp","unshift","child","spawnSync","match","exec","stdout","execGyp","spawnOpts","quiet","stdio","console","log","spawn","on","onGypClose","build","rebuild","cmds","cleanCb","jobs","Math","round","moveBuild","filePath","destination","rename","download","hasCalledBack","fileName","url","startsWith","client","get","getFile","res","statusCode","unzip","createGunzip","buffers","size","pipe","onResData","data","push","onResError","message","onResEnd","Buffer","concat","resume","saveDownload","makePathCB","writeFile","install","errors","noBuild","NR_NATIVE_METRICS_NO_BUILD","noDownload","NR_NATIVE_METRICS_NO_DOWNLOAD","doDownload","buildCB","moveBuildCB","doCallback","downloadCB","upload","zip","createGzip","createReadStream","AWS","s3","S3","Bucket","Key","Body","s3UploadCb","_argv","_opts","test","substr","buildCb","_endCli","error","exit"],"mappings":"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","sourcesContent":["'use strict'\n\n// This file is largely based upon the work done for node-pre-gyp. We are not\n// using that module directly due to issues we've run into with the intricacies\n// of various node and npm versions that we must support.\n// https://www.npmjs.com/package/node-pre-gyp\n\n// XXX This file must not have any deps. This file will run during the install\n// XXX step of the module and we are _not_ guaranteed that the dependencies have\n// XXX already installed. Core modules are okay.\nvar cp = require('child_process')\nvar fs = require('fs')\nvar http = require('http')\nvar https = require('https')\nvar os = require('os')\nvar path = require('path')\nvar semver = require('semver')\nvar zlib = require('zlib')\n\n\nvar CPU_COUNT = os.cpus().length\nvar IS_WIN = process.platform === 'win32'\nvar HAS_OLD_NODE_GYP_ARGS_FOR_WINDOWS = semver.lt(gypVersion() || '0.0.0', '3.7.0')\nvar S3_BUCKET = 'nr-downloads-main'\n\nvar DOWNLOAD_HOST = process.env.NR_NATIVE_METRICS_DOWNLOAD_HOST\n                  || 'https://download.newrelic.com/'\n\nvar REMOTE_PATH = process.env.NR_NATIVE_METRICS_REMOTE_PATH\n                || 'nodejs_agent/builds/'\n\nvar PACKAGE_ROOT = path.resolve(__dirname, '..')\nvar BUILD_PATH = path.resolve(PACKAGE_ROOT, './build/Release')\n\nvar opts = {}\nexports.load = load\n\nif (require.main === module) {\n  var argv = parseArgs(process.argv, opts)\n  executeCli(argv[2], argv[3])\n}\n\nfunction _getFileName(target) {\n  var abi = process.versions.modules\n  var arch = process.arch\n  var platform = process.platform\n  var pkg = require('../package')\n  var pkgName = pkg.name.replace(/[^\\w]/g, '_')\n  var pkgVersion = pkg.version.toString().replace(/[^\\w]/g, '_')\n\n  if (!abi || !arch || !target || !platform || !pkg || !pkgName || !pkgVersion) {\n    throw new Error('Missing information for naming compiled binary.')\n  }\n\n  return [pkgName, pkgVersion, target, abi, platform, arch].join('-')\n}\n\nfunction getBinFileName(target) {\n  return _getFileName(target) + '.node'\n}\n\nfunction getPackageFileName(target) {\n  return _getFileName(target) + '.gz'\n}\n\nfunction load(target) {\n  return require(path.join(BUILD_PATH, getBinFileName(target)))\n}\n\nfunction makePath(pathToMake, cb) {\n  var accessRights = null\n  if (fs.constants) {\n    accessRights = fs.constants.R_OK | fs.constants.W_OK\n  } else {\n    // TODO: Remove this when deprecating Node v5 and below.\n    accessRights = fs.R_OK | fs.W_OK\n  }\n\n  // We only want to make the parts after the package directory.\n  pathToMake = path.relative(PACKAGE_ROOT, pathToMake)\n\n  // Now that we have a relative path, split it into the parts we need to make.\n  var pathParts = pathToMake.split(path.sep)\n  _make(-1, PACKAGE_ROOT, cb)\n\n  function _make(i, p, cb) {\n    if (++i >= pathParts.length) {\n      return cb()\n    }\n    p = path.join(p, pathParts[i])\n\n    fs.access(p, accessRights, function fsAccessCB(err) {\n      if (!err) {\n        // It exists and we have read+write access! Move on to the next part.\n        return _make(i, p, cb)\n      } else if (err.code !== 'ENOENT') {\n        // It exists but we don't have read+write access! This is a problem.\n        return cb(new Error('Do not have access to \"' + p + '\": ' + err))\n      }\n\n      // It probably does not exist, so try to make it.\n      fs.mkdir(p, function fsMkDirCB(err) {\n        if (err) {\n          return cb(err)\n        }\n        _make(i, p, cb)\n      })\n    })\n  }\n}\n\nfunction findNodeGyp() {\n  // This code heavily borrows from node-pre-gyp.\n  // https://github.com/mapbox/node-pre-gyp/blob/e0b3b6/lib/util/compile.js#L18-L55\n\n  // First, look for it in the NPM environment variable.\n  var gypPath = null\n  if (process.env.npm_config_node_gyp) {\n    try {\n      gypPath = process.env.npm_config_node_gyp\n      if (fs.existsSync(gypPath)) {\n        return gypPath\n      }\n    } catch (err) {\n      // This method failed, hopefully the next will succeed...\n    }\n  }\n\n  // Next, see if the package is installed somewhere.\n  try {\n    var gypPkgPath = require.resolve('node-gyp')\n    gypPath = path.resolve(gypPkgPath, '../../bin/node-gyp.js')\n    if (fs.existsSync(gypPath)) {\n      return gypPath\n    }\n  } catch (err) {\n    // This method failed, hopefully the next will succeed...\n  }\n\n  // Then look for it in NPM's install location.\n  try {\n    var npmPkgPath = require.resolve('npm')\n    gypPath = path.resolve(npmPkgPath, '../../node_modules/node-gyp/bin/node-gyp.js')\n    if (fs.existsSync(gypPath)) {\n      return gypPath\n    }\n  } catch (err) {\n    // This method failed, hopefully the next will succeed...\n  }\n\n  // All of that failed, now look for it next to node itself.\n  var nodeNpmPkgPath = path.resolve(process.execPath, '../../lib/node_modules/npm/')\n  gypPath = path.join(nodeNpmPkgPath, 'node_modules/node-gyp/bin/node-gyp.js')\n  if (fs.existsSync(gypPath)) {\n    return gypPath\n  }\n\n  return null\n}\n\nfunction gypVersion() {\n  var cmd = null\n  var args = ['-v']\n  var gyp = findNodeGyp()\n  if (gyp) {\n    args.unshift(gyp) // push_front\n    cmd = process.execPath\n  } else {\n    cmd = IS_WIN ? 'node-gyp.cmd' : 'node-gyp'\n  }\n\n  var child = cp.spawnSync(cmd, args)\n  var match = /v(\\d+\\.\\d+\\.\\d+)/.exec(child.stdout)\n  return match && match[1]\n}\n\nfunction execGyp(args, cb) {\n  var cmd = null\n  var gyp = findNodeGyp()\n  if (gyp) {\n    args.unshift(gyp) // push_front\n    cmd = process.execPath\n  } else {\n    cmd = IS_WIN ? 'node-gyp.cmd' : 'node-gyp'\n  }\n\n  var spawnOpts = {}\n  if (!opts.quiet) {\n    spawnOpts.stdio = [0, 1, 2]\n  }\n  console.log('> ' + cmd + ' ' + args.join(' ')) // eslint-disable-line no-console\n\n  var child = cp.spawn(cmd, args, spawnOpts)\n  child.on('error', cb)\n  child.on('close', function onGypClose(code) {\n    if (code !== 0) {\n      cb(new Error('Command exited with non-zero code: ' + code))\n    } else {\n      cb(null)\n    }\n  })\n}\n\nfunction build(target, rebuild, cb) {\n  if (IS_WIN && HAS_OLD_NODE_GYP_ARGS_FOR_WINDOWS) {\n    target = '/t:' + target\n  }\n\n  var cmds = rebuild ? ['clean', 'configure'] : ['configure']\n\n  execGyp(cmds, function cleanCb(err) {\n    if (err) {\n      return cb(err)\n    }\n\n    var jobs = Math.round(CPU_COUNT / 2)\n    execGyp(['build', '-j', jobs, target], cb)\n  })\n}\n\nfunction moveBuild(target, cb) {\n  var filePath = path.join(BUILD_PATH, target + '.node')\n  var destination = path.join(BUILD_PATH, getBinFileName(target))\n  fs.rename(filePath, destination, cb)\n}\n\nfunction download(target, cb) {\n  var hasCalledBack = false\n  var fileName = getPackageFileName(target)\n  var url = DOWNLOAD_HOST + REMOTE_PATH + fileName\n\n  if (DOWNLOAD_HOST.startsWith('https:')) {\n    var client = https\n  } else {\n    console.log(\n      'Falling back to http, please consider enabling SSL on ' + DOWNLOAD_HOST\n    )\n    var client = http\n  }\n\n  client.get(url, function getFile(res) {\n     if (res.statusCode === 404) {\n      return cb(new Error('No pre-built artifacts for your OS/architecture.'))\n    } else if (res.statusCode !== 200) {\n      return cb(new Error('Failed to download ' + url + ': code ' + res.statusCode))\n    }\n\n    var unzip = zlib.createGunzip()\n    var buffers = []\n    var size = 0\n    res.pipe(unzip).on('data', function onResData(data) {\n      buffers.push(data)\n      size += data.length\n    })\n\n    res.on('error', function onResError(err) {\n      if (!hasCalledBack) {\n        hasCalledBack = true\n        cb(new Error('Failed to download ' + url + ': ' + err.message))\n      }\n    })\n\n    unzip.on('error', function onResError(err) {\n      if (!hasCalledBack) {\n        hasCalledBack = true\n        cb(new Error('Failed to unzip ' + url + ': ' + err.message))\n      }\n    })\n\n    unzip.on('end', function onResEnd() {\n      if (hasCalledBack) {\n        return\n      }\n      hasCalledBack = true\n      cb(null, Buffer.concat(buffers, size))\n    })\n\n    res.resume()\n  })\n}\n\nfunction saveDownload(target, data, cb) {\n  makePath(BUILD_PATH, function makePathCB(err) {\n    if (err) {\n      return cb(err)\n    }\n\n    var filePath = path.join(BUILD_PATH, getBinFileName(target))\n    fs.writeFile(filePath, data, cb)\n  })\n}\n\nfunction install(target, cb) {\n  var errors = []\n\n  var noBuild = opts['no-build'] || process.env.NR_NATIVE_METRICS_NO_BUILD\n  var noDownload = opts['no-download'] || process.env.NR_NATIVE_METRICS_NO_DOWNLOAD\n\n  // If NR_NATIVE_METRICS_NO_BUILD env var is specified, jump straight to downloading\n  if (noBuild) {\n    return doDownload()\n  }\n\n  // Otherwise, first attempt to build the package using the source. If that fails, try\n  // downloading the package. If that also fails, whoops!\n  build(target, true, function buildCB(err) {\n    if (!err) {\n      return moveBuild(target, function moveBuildCB(err) {\n        if (err) {\n          errors.push(err)\n          doDownload()\n        } else {\n          doCallback()\n        }\n      })\n    }\n    errors.push(err)\n\n    // Building failed, try downloading.\n    doDownload()\n  })\n\n  function doDownload() {\n    if (noDownload && !noBuild) {\n      return doCallback(new Error('Downloading is disabled.'))\n    }\n\n    download(target, function downloadCB(err, data) {\n      if (err) {\n        return doCallback(err)\n      }\n\n      saveDownload(target, data, doCallback)\n    })\n  }\n\n  function doCallback(err) {\n    if (err) {\n      errors.push(err)\n      cb(err)\n    } else {\n      cb()\n    }\n  }\n}\n\nfunction upload(target, cb) {\n  // XXX This is the one external dep allowed by this module. The aws-sdk must\n  // XXX be a dev-dep of the module and uploading should only be done after\n  // XXX installing.\n\n  var zip = zlib.createGzip()\n  fs.createReadStream(path.join(BUILD_PATH, getBinFileName(target))).pipe(zip)\n\n  // AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY must be set in the environment.\n  var AWS = require('aws-sdk')\n  var s3 = new AWS.S3()\n  s3.upload({\n    Bucket: S3_BUCKET,\n    Key: path.join(REMOTE_PATH, getPackageFileName(target)),\n    Body: zip\n  }, function s3UploadCb(err) {\n    if (err) {\n      cb(new Error('Failed to upload file: ' + err.message))\n    } else {\n      cb()\n    }\n  })\n}\n\nfunction parseArgs(_argv, _opts) {\n  var args = []\n  for (var i = 0; i < _argv.length; ++i) {\n    if (/^--/.test(_argv[i])) {\n      _opts[_argv[i].substr(2)] = true\n    } else {\n      args.push(_argv[i])\n    }\n  }\n  return args\n}\n\nfunction executeCli(cmd, target) {\n  /* eslint-disable no-console */\n  console.log(\n    [\n      '============================================================================',\n      `Attempting ${cmd} in native-metrics module. Please note that this is an`,\n      'OPTIONAL dependency, and any resultant errors in this process will not',\n      'affect the general performance of the New Relic agent, but event loop and',\n      'garbage collection metrics will not be collected.',\n      '============================================================================',\n      ''\n    ].join('\\n')\n  )\n\n  if (cmd === 'build' || cmd === 'rebuild') {\n    build(target, cmd === 'rebuild', function buildCb(err) {\n      if (err) {\n        _endCli(err)\n      } else {\n        moveBuild(target, _endCli)\n      }\n    })\n  } else if (cmd === 'install') {\n    install(target, _endCli)\n  } else if (cmd === 'upload') {\n    upload(target, _endCli)\n  }\n\n  function _endCli(err) {\n    if (err) {\n      console.error(`Failed to execute native-metrics ${cmd}: ${err.message}`)\n      process.exit(1)\n    } else {\n      console.log(cmd + ' successful: ' + _getFileName(target))\n    }\n  }\n  /* eslint-enable no-console */\n}\n"]},"metadata":{},"sourceType":"script"}